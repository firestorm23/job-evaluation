<?php

namespace SiteBundle\Repository;

/**
 * GoodRepository
 *
 * This class was generated by the Doctrine ORM. Add your own custom
 * repository methods below.
 */
class GoodRepository extends \Doctrine\ORM\EntityRepository
{

    public function getGoodsNative($price_type) {
        $sql = "
        SELECT g.title, pr.price, GROUP_CONCAT(CONCAT(p.dirname, \"/\", p.name) SEPARATOR \"\\n\") as files
        FROM vacancy2.good g
        JOIN good_photos gp ON g.id = gp.good_id
        JOIN photo p ON gp.photo_id = p.id
        JOIN price pr ON pr.good_id = g.id
        WHERE pr.price_type_id = $price_type GROUP BY g.id";

        $stmt = $this->_em->getConnection()->prepare($sql);
        $stmt->execute();
        return $stmt->fetchAll();
    }

    public function getGoodsQueryBuilder($price_type) {
        $qb = $this->createQueryBuilder('g')->join('g.prices', 'pr');
        $qb->where($qb->expr()->eq('pr.priceTypeId', $price_type))
            ->groupBy('g.id');

        return $qb->getQuery()
            ->getResult();
    }
}
